# Clarify 命令

## 目的

澄清规范中的模糊点,解决需求中的不明确问题。

## 使用场景

- AI在生成spec时提出了问题
- 规范中有需要明确的边界条件
- 有多个可能的实现方案需要确认
- 团队对某些需求理解不一致

## 输出文件

更新 `specs/[###-feature-name]/spec.md`,添加 **Clarifications** 部分

## 执行步骤

### 1. 识别需要澄清的点

常见的模糊点类型:
- **边界条件**: 如"最大值是多少?"、"空值如何处理?"
- **行为细节**: 如"失败后如何重试?"、"超时时间是多少?"
- **优先级冲突**: 如"A和B功能冲突时,优先哪个?"
- **降级策略**: 如"服务不可用时如何降级?"
- **数据格式**: 如"日期格式是什么?"、"精度要求多少?"

### 2. 收集澄清信息

询问用户以下问题:
- 需要澄清什么具体问题?
- 期望的行为是什么?
- 是否有降级或备选方案?
- 是否有特殊的约束条件?

### 3. 更新Spec文档

在spec.md中添加 **Clarifications** 部分:

```markdown
## Clarifications

### [澄清主题1]

**Q**: [问题描述]

**A**: [明确的回答]

**Rationale**: [为什么这样决策]

---

### [澄清主题2]

**Q**: [问题描述]

**A**: [明确的回答]

**Rationale**: [为什么这样决策]
```

### 4. 验证澄清结果

检查清单:
- [ ] 问题是否被明确回答?
- [ ] 回答是否具体可执行?
- [ ] 是否考虑了边界情况?
- [ ] 是否与现有需求一致?
- [ ] 是否需要更新其他部分?

### 5. 同步更新相关章节

如果澄清结果影响其他部分,需要同步更新:
- User Stories的验收标准
- Functional Requirements
- Success Criteria
- Edge Cases

### 6. 下一步引导

完成后,告知用户:

```
✅ Clarifications 已添加到 Spec!

已澄清的问题:
- [问题1]
- [问题2]

下一步:
- 检查是否还有其他需要澄清的地方
- 如果所有问题都已澄清,使用 `/plan` 命令制定技术方案
```

## 示例

### 示例1: 用户登录功能澄清

原始Spec中的模糊点:
- 验证码格式不明确
- 失败重试策略不清晰
- 锁定机制细节缺失

澄清后添加的内容:

```markdown
## Clarifications

### 验证码格式和生成规则

**Q**: 验证码应该是纯数字还是包含字母?长度是多少?

**A**: 验证码必须是6位纯数字,范围 000000-999999,随机生成。

**Rationale**: 
- 纯数字方便用户输入,特别是在移动端
- 6位数字提供100万种组合,足够安全
- 避免字母可防止0/O、1/l等混淆

---

### 验证码发送频率限制

**Q**: 如何防止用户频繁请求验证码?

**A**: 实施以下限制:
- 同一手机号1分钟内只能发送1次验证码
- 同一IP地址1分钟内最多发送3次验证码
- 同一手机号1小时内最多发送10次验证码

**Rationale**: 
- 防止短信轰炸攻击
- 降低短信成本
- 提升用户体验(避免收到过多验证码)

---

### 验证码错误锁定机制

**Q**: 用户多次输入错误验证码后如何处理?

**A**: 
- 用户连续输入错误验证码5次后,账号锁定10分钟
- 锁定期间不允许发送新验证码,不允许尝试登录
- 锁定结束后自动解锁,无需人工干预
- 成功登录后错误计数清零

**Rationale**: 
- 防止暴力破解
- 10分钟锁定时间平衡安全性和用户体验
- 自动解锁避免增加客服负担

---

### 验证码过期处理

**Q**: 验证码过期后用户如何操作?

**A**: 
- 验证码有效期固定为60秒
- 过期后用户尝试登录,显示"验证码已过期,请重新发送"
- 用户可直接点击"重新发送"按钮获取新验证码
- 旧验证码过期后立即失效,不能再使用

**Rationale**: 
- 60秒足够用户输入验证码
- 过期提示清晰明确,引导用户重新操作
- 及时失效提升安全性

---

### 短信服务不可用降级策略

**Q**: 如果短信服务不可用,如何处理?

**A**: 
- 主短信服务失败后,自动切换到备用短信服务商
- 如果两个服务商都失败,记录错误日志,向用户显示"短信服务暂时不可用,请稍后重试"
- 不提供其他登录方式(初期版本)
- 运维团队收到告警,及时处理

**Rationale**: 
- 双服务商提升可用性
- 初期版本简化实现,后续可增加其他登录方式
- 透明的错误提示提升用户体验
```

### 示例2: 商品搜索功能澄清

原始Spec中的模糊点:
- 搜索匹配规则不明确
- 筛选条件的组合逻辑不清晰
- 搜索性能要求不具体

澄清后添加的内容:

```markdown
## Clarifications

### 搜索匹配规则

**Q**: 搜索关键词如何匹配商品?

**A**: 
- 关键词分词后进行模糊匹配
- 匹配字段: 商品标题(权重3)、商品描述(权重1)、品牌(权重2)
- 不区分大小写
- 中文支持拼音首字母搜索
- 支持同义词匹配(如"手机"匹配"移动电话")

**Rationale**: 
- 分词提升搜索准确性
- 权重确保标题匹配优先显示
- 拼音搜索提升用户体验
- 同义词扩展搜索覆盖范围

---

### 筛选条件组合逻辑

**Q**: 用户选择多个筛选条件时,如何组合?

**A**: 
- 同类筛选(如多个品牌)使用OR逻辑
- 不同类筛选(如品牌+价格)使用AND逻辑
- 示例: "品牌=Apple OR Samsung" AND "价格=1000-5000"

**Rationale**: 
- 同类OR符合用户心智模型("苹果或三星的手机")
- 不同类AND确保结果精确("苹果或三星的1000-5000元手机")

---

### 搜索性能要求

**Q**: 搜索响应时间具体要求是什么?

**A**: 
- P95响应时间 < 500ms
- P99响应时间 < 1000ms
- 数据量: 支持100万商品
- 并发: 支持1000 QPS

**Rationale**: 
- 500ms保证良好的用户体验
- 1000ms作为最大容忍时间
- 100万商品覆盖中型电商规模
- 1000 QPS满足日常流量需求

---

### 搜索结果为空时的处理

**Q**: 搜索结果为0时,如何引导用户?

**A**: 
- 显示"未找到相关商品"提示
- 提供以下建议:
  - 检查关键词拼写
  - 减少关键词数量
  - 使用更通用的关键词
- 推荐热门商品(最多8个)
- 推荐相关分类(最多4个)

**Rationale**: 
- 明确告知用户结果为空
- 建议帮助用户调整搜索策略
- 推荐引导用户继续浏览
- 减少用户流失

---

### 特殊字符处理

**Q**: 用户输入特殊字符(如#、*、%)如何处理?

**A**: 
- 自动过滤SQL注入相关特殊字符
- 保留部分有意义的特殊字符(如+、-、")用于搜索语法
- 示例: "iPhone 13 Pro+" 保留"+"
- 其他特殊字符(如#、*、%)视为空格处理

**Rationale**: 
- 安全优先,防止注入攻击
- 保留搜索语法提升专业用户体验
- 其他特殊字符不影响搜索结果
```

## 常见澄清主题

### 1. 数据格式

```markdown
### 日期时间格式

**Q**: 系统使用什么日期时间格式?

**A**: 
- 存储: UTC时间戳(Unix timestamp)
- API: ISO 8601格式(2026-01-29T10:30:00Z)
- 前端显示: 用户本地时区,格式"YYYY-MM-DD HH:mm"

**Rationale**: 
- UTC时间戳便于计算和比较
- ISO 8601是国际标准,便于跨系统交互
- 本地时区显示提升用户体验
```

### 2. 错误处理

```markdown
### 网络请求失败处理

**Q**: API请求失败时如何处理?

**A**: 
- 自动重试: 最多3次,指数退避(1s, 2s, 4s)
- 重试后仍失败: 显示错误提示"网络连接失败,请检查网络设置"
- 提供"重试"按钮
- 记录错误日志,包含请求参数和错误信息

**Rationale**: 
- 自动重试减少网络波动影响
- 指数退避避免服务过载
- 明确的错误提示引导用户
- 日志便于排查问题
```

### 3. 性能要求

```markdown
### 图片加载性能

**Q**: 图片加载有什么性能要求?

**A**: 
- 缩略图: < 100KB, 加载时间 < 500ms
- 大图: < 500KB, 加载时间 < 2s
- 使用懒加载,只加载可见区域的图片
- 使用WebP格式,降级支持JPEG

**Rationale**: 
- 小文件确保快速加载
- 懒加载降低初始加载时间
- WebP压缩率更高,节省带宽
```

### 4. 边界条件

```markdown
### 输入长度限制

**Q**: 用户输入的文本有什么长度限制?

**A**: 
- 用户名: 2-20个字符
- 密码: 8-32个字符
- 评论: 1-500个字符
- 标题: 1-100个字符

**Rationale**: 
- 最小长度确保有效输入
- 最大长度防止恶意输入和数据库溢出
- 长度合理,满足正常使用场景
```

## 注意事项

⚠️ **重要**:
- 澄清必须具体可执行,不能模糊
- 澄清结果要与现有需求保持一致
- 重大澄清需要同步更新Plan和Tasks
- 澄清决策要有明确的理由(Rationale)
- 澄清后使用 `/analyze` 验证一致性

## 常见问题

### Q: 什么时候需要使用Clarify?

A: 当spec中有任何模糊或不明确的地方时。宁可过度澄清,也不要留下模糊点。

### Q: Clarify会影响已有的Plan吗?

A: 可能会。如果澄清结果与Plan冲突,需要更新Plan。

### Q: 澄清应该多详细?

A: 详细到可以直接指导实现。如果开发者看到澄清后还有疑问,说明不够详细。

### Q: 可以多次Clarify吗?

A: 可以。Clarifications部分可以持续更新,直到所有问题都被澄清。
